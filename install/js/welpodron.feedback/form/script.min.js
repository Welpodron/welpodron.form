"use strict";(c=>{if(c.welpodron&&c.welpodron.utils&&c.welpodron.templater&&!c.welpodron.feedbackForm){var e="feedback";const l=`welpodron.${e}:submit:after`;class t{element;action="";isDisabled=!1;responseContainer;captchaLoaded=null;captchaKey=null;constructor({element:e}){this.element=e,this.element.removeEventListener("input",this.handleFormInput),this.element.addEventListener("input",this.handleFormInput),this.element.removeEventListener("submit",this.handleFormSubmit),this.element.addEventListener("submit",this.handleFormSubmit),this.responseContainer=document.createElement("div"),this.element.prepend(this.responseContainer),this.captchaKey=this.element.getAttribute("data-captcha"),this.action=this.element.getAttribute("action")||"",this.disable(),this.captchaKey?(this.captchaLoaded=c.welpodron.utils.deferred(),c.grecaptcha?c.grecaptcha.ready(()=>{this.element.checkValidity()&&this.enable(),this.captchaLoaded?.resolve()}):(c.addEventListener("scroll",e=()=>{var e;document.querySelector('script[src*="recaptcha"]')?(this.element.checkValidity()&&this.enable(),this.captchaLoaded?.resolve()):((e=document.createElement("script")).src="https://www.google.com/recaptcha/api.js?render="+this.captchaKey,document.body.appendChild(e),e.onload=()=>{c.grecaptcha.ready(()=>{this.element.checkValidity()&&this.enable(),this.captchaLoaded?.resolve()})})},{once:!0,passive:!0}),c.addEventListener("touchstart",e,{once:!0}),document.addEventListener("mouseenter",e,{once:!0}),document.addEventListener("click",e,{once:!0}))):this.element.checkValidity()&&this.enable()}handleFormSubmit=async t=>{if(t.preventDefault(),this.action.trim().length&&!this.isDisabled){this.disable();var i,t=new FormData(this.element);this.captchaKey&&(i=await c.grecaptcha.execute(this.captchaKey,{action:"submit"}),t.set("g-recaptcha-response",i)),c.BX&&c.BX.bitrix_sessid&&t.set("sessid",c.BX.bitrix_sessid());let e=new CustomEvent("welpodron.feedback:submit:before",{bubbles:!0,cancelable:!0,detail:{data:t,form:this.element}});if(this.element.dispatchEvent(e))try{var s=await fetch(this.action,{method:"POST",body:t});if(!s.ok)throw new Error(s.statusText);var n=await s.json();if("error"===n.status){var a=n.errors[0];if("FIELD_VALIDATION_ERROR"===a.code){const r=this.element.elements[a.customData];r&&(r.setCustomValidity(a.message),r.reportValidity(),r.addEventListener("input",()=>{r.setCustomValidity(""),r.reportValidity(),r.checkValidity()},{once:!0}))}throw"FORM_GENERAL_ERROR"===a.code&&c.welpodron.templater.renderHTML({string:a.message,container:this.responseContainer,config:{replace:!0}}),new Error(a.message)}"success"===n.status&&(c.welpodron.templater.renderHTML({string:n.data,container:this.responseContainer,config:{replace:!0}}),this.element.reset())}catch(e){console.error(e)}finally{e=new CustomEvent(l,{bubbles:!0,cancelable:!1}),this.element.dispatchEvent(e),this.element.checkValidity()?this.enable():this.disable()}else e=new CustomEvent(l,{bubbles:!0,cancelable:!1}),this.element.dispatchEvent(e),this.element.checkValidity()?this.enable():this.disable()}};handleFormInput=e=>{if(this.element.checkValidity())return this.enable();this.disable()};disable=()=>{this.isDisabled=!0,[...this.element.elements].filter(e=>(e instanceof HTMLButtonElement||e instanceof HTMLInputElement)&&"submit"===e.type).forEach(e=>{e.setAttribute("disabled","")})};enable=()=>{this.isDisabled=!1,[...this.element.elements].filter(e=>(e instanceof HTMLButtonElement||e instanceof HTMLInputElement)&&"submit"===e.type).forEach(e=>{e.removeAttribute("disabled")})}}c.welpodron.feedbackForm=t}})(window);
//# sourceMappingURL=script.min.js.map